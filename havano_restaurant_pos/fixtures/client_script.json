[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Invoice",
  "enabled": 1,
  "modified": "2026-01-20 08:44:50.429377",
  "module": "Havano Restaurant Pos",
  "name": "print invoice",
  "script": "// Custom Script for Sales Invoice (Client)\nfrappe.ui.form.on('Sales Invoice', {\n    refresh: function(frm) {\n        // Fetch the HA POS Settings\n        frappe.db.get_single_value('HA POS Settings', 'can_print_invoice')\n        .then((can_print_invoice) => {\n            console.log(\"HA POS Settings can_print_invoice:\", can_print_invoice);\n\n            // Only show the manual button if allowed\n            if (can_print_invoice) {\n                frm.add_custom_button(__('Print Invoice'), function() {\n                    downloadInvoice(frm.doc.name);\n                }, __('Actions'));\n            }\n\n            // Store setting on form so after_save can access it\n            frm.can_print_invoice = can_print_invoice;\n        });\n    },\n\n    after_save: function(frm) {\n        // Auto-download only if allowed\n        if (frm.can_print_invoice) {\n            console.log(\"Auto-downloading invoice:\", frm.doc.name);\n            downloadInvoice(frm.doc.name);\n        }\n    }\n});\n\n// Helper function for download (manual or auto)\nfunction downloadInvoice(invoiceNumber) {\n    frappe.call({\n        method: \"havano_restaurant_pos.api.get_invoice_json\",\n        args: { invoice_name: invoiceNumber },\n        callback: function(r) {\n            if (r.message) {\n                const blob = new Blob([JSON.stringify(r.message, null, 4)], { type: \"text/plain\" });\n                const link = document.createElement(\"a\");\n                link.href = URL.createObjectURL(blob);\n                link.download = invoiceNumber + \".txt\";\n                link.click();\n                console.log(\"Invoice downloaded:\", invoiceNumber);\n            } else {\n                frappe.msgprint(__('No invoice data returned.'));\n                console.log(\"No invoice data returned for download.\");\n            }\n        },\n        error: function(err) {\n            console.error(\"Error calling get_invoice_json:\", err);\n            frappe.msgprint(__('Error downloading invoice JSON. Check console.'));\n        }\n    });\n}\n",
  "view": "Form"
 }
]